**Computational Environment**
Analyses were run in a Python 3.11 environment with specified versions of key libraries (scanpy, numpy, scipy, pandas, matplotlib, plotnine) and pip-installed decoupler, liana, and partipy (pinned commit) as listed in `env.yaml`. (`env.yaml:L1–L23`)

**Benchmarking Initialization and Optimization Algorithms**
Benchmark datasets were loaded via helper functions that download/cache MS snRNA-seq, MS Xenium, and lupus PBMC `.h5ad` files with checksum validation before reading into AnnData. (`code/utils/data_utils.py:L50–L145`; `code/utils/data_utils.py:L246–L281`; `code/utils/data_utils.py:L284–L307`)
The lupus loader additionally remapped disease-state labels, dropped unused metadata fields, reset observation indices, replaced counts with `adata.raw.X`, mapped gene symbols, filtered lowly expressed genes, and removed processing cohort 4.0. (`code/utils/data_utils.py:L308–L359`)
For MS and lupus benchmarks, each selected cell type subset was normalized and log1p-transformed, highly variable genes were selected, PCA was computed on HVGs, and the first 10 PCs were set as AA input. (`code/benchmark_algorithms/ms_bench.py:L93–L129`; `code/benchmark_algorithms/lupus_bench.py:L95–L122`)
For the MS Xenium benchmark, data were normalized and log1p-transformed, PCA was computed without HVG selection, and the first 10 PCs were used as AA input. (`code/benchmark_algorithms/ms_xenium_bench.py:L125–L149`)
MS Xenium Level2 annotations were remapped to broader cell-type categories using a predefined mapping. (`code/benchmark_algorithms/ms_xenium_bench.py:L56–L85`)
Shuffled PCA diagnostics and archetype selection metrics (variance explained and information criterion) were computed for K=2–9, and bootstrap variance was computed with n_bootstrap=10 for MS and n_bootstrap=20 with coreset_fraction=0.10 for lupus and Xenium. (`code/benchmark_algorithms/ms_bench.py:L121–L149`; `code/benchmark_algorithms/lupus_bench.py:L116–L135`; `code/benchmark_algorithms/ms_xenium_bench.py:L143–L162`)
Initialization algorithms were taken from `INIT_ALGS` and optimization algorithms from `OPTIM_ALGS` with `regularized_nnls` excluded, and benchmarks iterated across predefined seed lists from `SEED_DICT`. (`code/benchmark_algorithms/ms_bench.py:L29–L45`; `code/benchmark_algorithms/lupus_bench.py:L28–L43`; `code/benchmark_algorithms/ms_xenium_bench.py:L28–L43`; `code/utils/const.py:L21–L35`)
For each cell type, init/optim pair, and seed, archetypes were fit with `n_restarts=1`, and runtime, RSS, variance explained, and dataset dimensions were recorded. (`code/benchmark_algorithms/ms_bench.py:L165–L196`; `code/benchmark_algorithms/lupus_bench.py:L151–L182`; `code/benchmark_algorithms/ms_xenium_bench.py:L178–L207`)
Benchmark results were saved to CSV and aggregated into z-scored summaries and plots across datasets and settings. (`code/benchmark_algorithms/ms_bench.py:L200–L201`; `code/benchmark_algorithms/lupus_bench.py:L186–L187`; `code/benchmark_algorithms/ms_xenium_bench.py:L211–L212`; `code/benchmark_algorithms/bench_meta.py:L18–L107`)
Simulated benchmarks generated synthetic archetypal datasets across sample sizes, feature dimensions, archetype counts, and noise levels, fit AA models per init/optim pair, aligned learned archetypes to ground truth, computed normalized L2 distances, and saved results. (`code/benchmark_algorithms/simulated_data.py:L29–L119`)

**Coreset Benchmarking (v2)**
Coreset fractions were evaluated as 1.0 plus a geometric series defined by 1/(2^n*(25/16)) for n=0..7. (`code/benchmark_coresets/ms_coreset_v2.py:L241–L244`)
For MS, lupus, and MS Xenium coreset benchmarks, cell-type subsets were normalized and log1p-transformed, HVGs selected, PCA computed, a z_scaled layer added, and the first 10 PCs set as AA input. (`code/benchmark_coresets/ms_coreset_v2.py:L293–L324`; `code/benchmark_coresets/lupus_coreset_v2.py:L276–L300`; `code/benchmark_coresets/ms_xenium_coreset_v2.py:L306–L329`)
Reference archetypes were computed with `n_restarts=5` and seed 42, followed by archetype weights and z_scaled expression profiles, and bootstrap statistics were estimated with `compute_bootstrap_stats` using 50–100 bootstrap samples depending on dataset. (`code/benchmark_coresets/ms_coreset_v2.py:L327–L349`; `code/benchmark_coresets/lupus_coreset_v2.py:L302–L325`; `code/benchmark_coresets/ms_xenium_coreset_v2.py:L331–L353`)
The bootstrap routine resampled observations with replacement, fit AA models per bootstrap sample, aligned archetypes to a reference, and computed means, variances, covariance matrices with ridge regularization, and Mahalanobis/scaled-Euclidean distances. (`code/benchmark_coresets/ms_coreset_v2.py:L50–L201`)
For each coreset fraction and seed, archetypes were fit with `coreset_algorithm='standard'` when the fraction was <1 (and coreset disabled for full-data runs), and metrics recorded included RSS_full, variance explained, Euclidean distances after Hungarian alignment, bootstrap distance percentiles, and Pearson correlations of archetype expression. (`code/benchmark_coresets/ms_coreset_v2.py:L362–L455`)
Minimal coreset fractions achieving within 1% of full-data variance explained were estimated using GAMs with B-splines, and time savings were computed by comparing full-data runtime to predicted runtime at the minimal coreset size. (`code/benchmark_coresets/ms_coreset_v2.py:L487–L673`)
Across datasets, summary tables and plots reported time fraction (coreset_time/full_time), time savings, and minimal coreset fraction as a function of cell count. (`code/benchmark_coresets/coreset_meta_v2.py:L19–L115`)

**Memory and Time Benchmarking**
Memory benchmarks constrained BLAS threads to 1 and measured RSS via `/proc` and `ru_maxrss`, sampling every 50 ms during copy and compute phases. (`code/benchmark_memory/k562_memory_bench.py:L12–L76`)
K562, HCT116, and HEK293T benchmarks read local `.h5ad` files, verified that inputs were not log-normalized, and subsampled to predefined n_cells ranges per dataset. (`code/benchmark_memory/k562_memory_bench.py:L184–L223`; `code/benchmark_memory/hct116_memory_bench.py:L183–L223`; `code/benchmark_memory/hek293t_memory_bench.py:L183–L223`; `code/utils/data_utils.py:L363–L425`)
Data preprocessing for memory benchmarks used normalize_total, log1p, highly_variable_genes (n_top_genes=2000), PCA with 20 components, and the first 20 PCs as AA input. (`code/benchmark_memory/k562_memory_bench.py:L226–L231`; `code/benchmark_memory/hct116_memory_bench.py:L226–L230`; `code/benchmark_memory/hek293t_memory_bench.py:L226–L230`)
Each configuration iterated over n_archetypes={3,6,9}, coreset_fraction={1.0,0.10}, and seeds from `SEED_DICT['s']`, with archetypes computed using `pt.compute_archetypes` (coreset enabled when fraction <1) in a separate process and a 1-hour timeout. (`code/benchmark_memory/k562_memory_bench.py:L204–L279`; `code/utils/const.py:L21–L25`)
Results recorded time and memory metrics for copy and compute phases and were written to CSV. (`code/benchmark_memory/k562_memory_bench.py:L128–L145`; `code/benchmark_memory/k562_memory_bench.py:L378–L425`)
An “only_pca” variant benchmarks AA optimization directly on PCA embeddings by copying the PCA matrix and fitting `pt.AA` without the full AnnData object. (`code/benchmark_memory/k562_memory_bench_only_pca.py:L62–L114`; `code/benchmark_memory/k562_memory_bench_only_pca.py:L247–L248`)
Memory and runtime summaries across datasets and coreset fractions were aggregated and plotted, including both full-workflow and PCA-only results. (`code/benchmark_memory/memory_meta.py:L15–L146`)

**Hepatocyte Case Study**
Hepatocyte data were loaded using `load_hepatocyte_data_2` with `data_dir=Path("data")`, and figure/output directories were created. (`code/examples/hepatocyte_example.py:L16–L26`)
Counts were normalized and log1p-transformed, HVGs selected, PCA computed on HVGs, and a z_scaled layer added. (`code/examples/hepatocyte_example.py:L27–L32`)
Shuffled PCA was computed and the first 3 PCs were used as AA input, with selection metrics computed for K=2–8 and bootstrap variance computed with n_bootstrap=50. (`code/examples/hepatocyte_example.py:L36–L55`)
Final archetypes were fit with K=4, 2D archetype and bootstrap plots generated, and archetype weights and z_scaled expression profiles computed. (`code/examples/hepatocyte_example.py:L58–L71`)
MSigDB Reactome gene sets were filtered by keyword exclusions and gene-set size thresholds, columns were renamed to `source`/`target`, and genes were translated to mouse using a custom HCOP-based mapping when `TRY_DOWNLOAD=False`. (`code/examples/hepatocyte_example.py:L72–L172`)
ULM was run on archetype expression with the translated Reactome resource and enriched processes extracted with p_threshold=0.05 (top n=10), with archetype weight plots and barplots generated. (`code/examples/hepatocyte_example.py:L174–L201`)
Spatial mapping used Vizgen data read with squidpy, filtered to shared genes and cells with total counts >200, normalized and log1p-transformed, then ULM scores were computed using archetype-expression weights and visualized after z-scoring and spatial subsampling. (`code/examples/hepatocyte_example.py:L203–L252`)
Crosstalk analysis used specific genes per archetype (min_score=0.05), the LIANA mouseconsensus resource, and a weighted network visualization with shell layout and seed=42. (`code/examples/hepatocyte_example.py:L255–L269`)

**Fibroblast Cross-Condition Case Study**
The fibroblast workflow set n_archetypes=3, used Harmony-corrected PCA embedding `X_pca_harmony` with 16 dimensions, and configured output directories and disease color mapping. (`code/examples/fibroblast_cross_condition.py:L45–L66`)
Marker gene lists for QC and archetype interpretation were defined, and deduplicated gene and TF lists were derived for plotting. (`code/examples/fibroblast_cross_condition.py:L70–L228`)
MSigDB resources were loaded via decoupler and cached to disk after removing duplicate gene–geneset pairs. (`code/examples/fibroblast_cross_condition.py:L248–L262`)
Data were read from `DATA_PATH/human_dcm_hcm_scportal_03.17.2022.h5ad`, subset to fibroblast cell types, and age groups were binned into categorical intervals. (`code/examples/fibroblast_cross_condition.py:L266–L283`)
QC feature flags (mitochondrial, ribosomal, hemoglobin) were created and QC metrics computed, then cells and genes were filtered by minimum counts and disease labels were recoded to NF vs CM. (`code/examples/fibroblast_cross_condition.py:L285–L306`; `code/examples/fibroblast_cross_condition.py:L297–L302`)
Counts were normalized and log1p-transformed, HVGs selected, PCA computed with 50 components, and a z_scaled layer created, followed by marker gene dotplots. (`code/examples/fibroblast_cross_condition.py:L308–L324`)
Harmony integration was run on donor_id to produce `X_pca_harmony` (and a secondary embedding with tau=1e3). (`code/examples/fibroblast_cross_condition.py:L326–L332`)
Shuffled PCA was computed with n_shuffle=25 unless `--quick` was specified, and the AA input was set to 16 Harmony PCs. (`code/examples/fibroblast_cross_condition.py:L337–L345`)
Archetype selection metrics were computed for K=2–7 and bootstrap variance with n_bootstrap=50 (or only K=3 in quick mode), followed by 2D archetype and bootstrap plots. (`code/examples/fibroblast_cross_condition.py:L349–L427`)
Archetype weights were computed in automatic mode, normalized to sum to one per archetype, stored in `adata.obs`, and meta-enrichment was computed for disease, original disease labels, cell type, and subcluster annotations. (`code/examples/fibroblast_cross_condition.py:L545–L583`)
For cross-condition analysis, archetype locations Z and cell embeddings X were extracted, donor-level pseudobulks were computed as mean PC coordinates per donor, and pseudobulks were projected onto the archetype convex hull using an AA model transform. (`code/examples/fibroblast_cross_condition.py:L708–L748`; `code/examples/fibroblast_cross_condition.py:L727–L737`)
Distances from each donor pseudobulk to each archetype were computed with Euclidean distance, plotted, and saved along with aggregated metadata. (`code/examples/fibroblast_cross_condition.py:L807–L863`)
Disease effects were tested with two-sided Welch’s t-tests on distances (NF vs CM), followed by Benjamini–Hochberg FDR correction and annotated boxplots. (`code/examples/fibroblast_cross_condition.py:L890–L968`)
A ridge-penalized logistic regression (alpha=1e-3) modeled CM outcome versus archetype distances plus sex covariate, with permutation-based empirical p-values (B_perm=10,000) and bootstrap confidence bands for predicted probabilities (B_boot=1,000). (`code/examples/fibroblast_cross_condition.py:L693–L1064`)
Archetype expression profiles were computed for raw, log1p, and z-scaled layers, reshaped to long format, filtered to genes with n_cells>100, and top genes per archetype were saved after applying a raw-expression threshold (>=1) and top_n=50. (`code/examples/fibroblast_cross_condition.py:L1108–L1163`)
Cells were assigned to their maximum-weight archetype to count NF cells closest to archetype 2 per donor, and fractions were visualized. (`code/examples/fibroblast_cross_condition.py:L1200–L1261`)
Transcription factor activity was inferred with decoupler ULM and the CollecTRI resource, significant TFs (p<=0.05) were saved, and TF activity heatmaps were plotted. (`code/examples/fibroblast_cross_condition.py:L1266–L1328`)
Pathway activity was inferred with decoupler ULM using Progeny; pathways were ordered by hierarchical clustering with optimal leaf ordering and visualized with significance markers. (`code/examples/fibroblast_cross_condition.py:L1333–L1401`)
MSigDB Hallmark enrichment was computed using ULM after filtering gene sets by size; top positive hallmarks per archetype were selected (p<=0.05, n=5) and plotted with clustered ordering. (`code/examples/fibroblast_cross_condition.py:L1406–L1525`)
MSigDB NABA Matrisome gene sets were filtered to exclude cancer-related sets and analyzed with ULM; matrisome terms were clustered and plotted. (`code/examples/fibroblast_cross_condition.py:L1530–L1620`)
Processed AnnData objects were written to the output directory and a fixed absolute path. (`code/examples/fibroblast_cross_condition.py:L1623–L1626`)
An integration-vs-no-integration comparison recomputed archetypes on `X_pca` and `X_pca_harmony` for K=3 and K=4, aligned archetypes via Hungarian assignment on correlation distance, and computed per-archetype Pearson correlations. (`code/examples/fibroblast_cross_condition.py:L1647–L1747`)
Quantile-based gene enrichment was computed on genes with n_cells>100 using `pt.compute_quantile_based_gene_enrichment` with n_archetypes=4. (`code/examples/fibroblast_cross_condition.py:L1752–L1758`)

**Missing Details to Fill In**
- Hardware/OS specifications for the benchmarking runs. ([NOT SPECIFIED IN CODE])
- Provenance and preprocessing steps for the fibroblast `.h5ad` input beyond the local file path. ([NOT SPECIFIED IN CODE])
- Provenance and preprocessing steps for the K562/HCT116/HEK293T memory benchmark `.h5ad` files. ([NOT SPECIFIED IN CODE])
- Explicit initialization/optimization settings for case-study archetype fits when defaults are used. ([NOT SPECIFIED IN CODE])
- Source/version metadata for the Vizgen spatial dataset beyond the local folder name. ([NOT SPECIFIED IN CODE])
